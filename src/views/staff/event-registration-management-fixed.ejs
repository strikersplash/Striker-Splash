<!-- Event Registration Management Interface -->
<div class="container mt-5">
  <div class="row">
    <div class="col-md-12">
      <div class="card mb-4">
        <div
          class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
        >
          <h3 class="mb-0">Event Registration Management</h3>
          <button type="button" class="btn btn-light" id="refresh-btn">
            <i class="bi bi-arrow-clockwise"></i> Refresh
          </button>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <i class="bi bi-info-circle-fill"></i> This interface allows you to
            manage event registrations and assign queue tickets to registered
            players.
          </div>

          <!-- Events List -->
          <div id="events-list">
            <h4 class="mb-3">Upcoming Events with Registrations</h4>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>Event Name</th>
                    <th>Location</th>
                    <th>Date</th>
                    <th>Total Registrations</th>
                    <th>Pending Tickets</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="events-table">
                  <!-- Will be populated by JavaScript -->
                  <tr>
                    <td colspan="6" class="text-center">Loading events...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Registrations for Selected Event -->
          <div id="event-registrations" class="mt-5 d-none">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h4 id="selected-event-name">Registrations</h4>
              <button
                type="button"
                class="btn btn-secondary"
                id="back-to-events"
              >
                <i class="bi bi-arrow-left"></i> Back to Events
              </button>
            </div>

            <div class="alert alert-warning mb-3" id="assign-instructions">
              <i class="bi bi-exclamation-triangle-fill"></i>
              Select players and click "Assign Queue Tickets" to assign tickets
              in the order they registered.
            </div>

            <div class="mb-3">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="select-all-registrations"
                />
                <label class="form-check-label" for="select-all-registrations">
                  Select All
                </label>
              </div>
              <button
                type="button"
                class="btn btn-success mt-2 d-none"
                id="assign-tickets-btn"
              >
                <i class="bi bi-ticket-perforated"></i> Assign Queue Tickets
              </button>
            </div>

            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th class="text-center" style="width: 50px">Select</th>
                    <th>Registration #</th>
                    <th>Player Name</th>
                    <th>Phone</th>
                    <th>Kicks</th>
                    <th>Registration Date</th>
                    <th>Type</th>
                  </tr>
                </thead>
                <tbody id="registrations-table">
                  <!-- Will be populated by JavaScript -->
                  <tr>
                    <td colspan="7" class="text-center">
                      Select an event to view registrations
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div
  class="modal fade"
  id="successModal"
  tabindex="-1"
  aria-labelledby="successModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="successModalLabel">Tickets Assigned</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="text-center mb-3">
          <i
            class="bi bi-check-circle"
            style="font-size: 3rem; color: #28a745"
          ></i>
        </div>
        <p id="success-message">
          Queue tickets have been successfully assigned.
        </p>
        <div id="assigned-tickets-list" class="mt-3">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Global variables to store DOM elements
  let eventsTable;
  let eventsListDiv;
  let eventRegistrationsDiv;
  let registrationsTable;
  let selectedEventName;
  let backToEventsBtn;
  let refreshBtn;
  let selectAllCheckbox;
  let assignTicketsBtn;
  let successMessage;
  let assignedTicketsList;
  let successModal;
  let currentEventId = null;

  // Function to view registrations - called directly from onclick
  function viewRegistrations(eventId, eventName) {
    console.log("View Registrations clicked for event:", eventId, eventName);

    // Ensure we have the DOM elements
    if (!eventRegistrationsDiv || !eventsListDiv) {
      console.error("DOM elements not found!");
      return;
    }

    currentEventId = eventId;
    selectedEventName.textContent = `Registrations for: ${eventName}`;

    registrationsTable.innerHTML =
      '<tr><td colspan="7" class="text-center">Loading registrations...</td></tr>';

    console.log(
      `Fetching registrations from: /staff/registered-players/${eventId}`
    );

    // Make sure we don't have a null eventId before making the request
    if (!eventId) {
      console.error("No event ID provided");
      registrationsTable.innerHTML =
        '<tr><td colspan="7" class="text-center text-danger">Error: No event ID provided</td></tr>';
      return;
    }

    fetch(`/staff/registered-players/${eventId}`)
      .then((response) => {
        console.log("Response status:", response.status);
        return response.json();
      })
      .then((data) => {
        console.log("Received data:", data);

        if (data.success && data.registrations) {
          if (data.registrations.length === 0) {
            registrationsTable.innerHTML =
              '<tr><td colspan="7" class="text-center">No pending registrations found for this event</td></tr>';
            assignTicketsBtn.classList.add("d-none");
            return;
          }

          registrationsTable.innerHTML = "";
          data.registrations.forEach((reg) => {
            const row = document.createElement("tr");

            // Format date
            const regDate = new Date(reg.registration_date);
            const formattedDate = regDate.toLocaleString();

            row.innerHTML = `
            <td class="text-center">
              <input type="checkbox" class="form-check-input registration-checkbox" value="${
                reg.registration_id
              }">
            </td>
            <td>#${reg.registration_number}</td>
            <td>
              ${reg.player_name}
              ${
                reg.age_group
                  ? `<small class="text-muted d-block">${reg.age_group}</small>`
                  : ""
              }
            </td>
            <td>${reg.phone}</td>
            <td>${reg.kicks_requested}</td>
            <td>${formattedDate}</td>
            <td>
              <span class="badge ${
                reg.is_competition ? "bg-warning" : "bg-info"
              }">
                ${reg.is_competition ? "Competition" : "Practice"}
              </span>
            </td>
          `;

            registrationsTable.appendChild(row);
          });

          // Show the assign tickets button if there are registrations
          assignTicketsBtn.classList.remove("d-none");

          // Add event listeners to checkboxes
          document
            .querySelectorAll(".registration-checkbox")
            .forEach((checkbox) => {
              checkbox.addEventListener("change", updateAssignButtonState);
            });
        } else {
          registrationsTable.innerHTML =
            '<tr><td colspan="7" class="text-center text-danger">Failed to load registrations</td></tr>';
          console.error("Error in data:", data);
        }

        // Show registrations section, hide events list
        console.log("Showing registrations section, hiding events list");
        eventsListDiv.classList.add("d-none");
        eventRegistrationsDiv.classList.remove("d-none");
      })
      .catch((error) => {
        console.error("Error loading registrations:", error);
        registrationsTable.innerHTML =
          '<tr><td colspan="7" class="text-center text-danger">Error loading registrations</td></tr>';
      });
  }

  // Load all events with their registration count
  function loadEvents() {
    console.log("Loading events...");

    if (!eventsTable) {
      console.error("Events table element not found!");
      return;
    }

    eventsTable.innerHTML =
      '<tr><td colspan="6" class="text-center">Loading events...</td></tr>';

    fetch("/staff/events-with-registrations")
      .then((response) => response.json())
      .then((data) => {
        console.log("Events data:", data);

        if (data.success && data.events) {
          if (data.events.length === 0) {
            eventsTable.innerHTML =
              '<tr><td colspan="6" class="text-center">No upcoming events found</td></tr>';
            return;
          }

          // Clear the table
          eventsTable.innerHTML = "";

          // Show all events, including those with zero registrations
          data.events.forEach((event) => {
            const row = document.createElement("tr");

            // Format date
            const startDate = new Date(event.start_date);
            const endDate = new Date(event.end_date);
            const formattedDate = `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`;

            // Create badge for pending tickets
            const pendingBadge =
              event.pending_ticket_assignments &&
              event.pending_ticket_assignments > 0
                ? `<span class="badge bg-warning">${event.pending_ticket_assignments}</span>`
                : `<span class="badge bg-secondary">0</span>`;

            const registrations = event.total_registrations || 0;

            row.innerHTML = `
            <td>${event.name}</td>
            <td>${event.address}</td>
            <td>${formattedDate}</td>
            <td>${registrations}</td>
            <td>${pendingBadge}</td>
            <td>
              ${
                registrations > 0
                  ? `<button type="button" class="btn btn-sm btn-primary view-registrations" 
                      data-event-id="${event.id}" 
                      data-event-name="${event.name}"
                      onclick="viewRegistrations('${
                        event.id
                      }', '${event.name.replace(/'/g, "\\'")}')"
                    >
                      <i class="bi bi-eye"></i> View Registrations
                    </button>`
                  : `<button type="button" class="btn btn-sm btn-secondary" disabled>
                      <i class="bi bi-x-circle"></i> No Registrations
                    </button>`
              }
            </td>
          `;

            eventsTable.appendChild(row);
          });
        } else {
          eventsTable.innerHTML =
            '<tr><td colspan="6" class="text-center text-danger">Failed to load events</td></tr>';
          console.error("Error in data:", data);
        }
      })
      .catch((error) => {
        console.error("Error loading events:", error);
        eventsTable.innerHTML =
          '<tr><td colspan="6" class="text-center text-danger">Error loading events</td></tr>';
      });
  }

  // Update assign button state based on checkbox selection
  function updateAssignButtonState() {
    const checkedBoxes = document.querySelectorAll(
      ".registration-checkbox:checked"
    );
    if (checkedBoxes.length > 0) {
      assignTicketsBtn.classList.remove("d-none");
      assignTicketsBtn.textContent = `Assign Queue Tickets (${checkedBoxes.length})`;
    } else {
      assignTicketsBtn.classList.add("d-none");
    }
  }

  // Assign tickets to selected registrations
  function assignTickets() {
    const checkedBoxes = document.querySelectorAll(
      ".registration-checkbox:checked"
    );

    if (checkedBoxes.length === 0) {
      return; // No registrations selected
    }

    const registrationIds = Array.from(checkedBoxes).map(
      (checkbox) => checkbox.value
    );

    // Show loading state
    assignTicketsBtn.disabled = true;
    assignTicketsBtn.innerHTML =
      '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Assigning tickets...';

    fetch(`/staff/assign-tickets/${currentEventId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ registrationIds }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          // Show success message
          successMessage.textContent = `${data.assignedTickets.length} queue tickets have been successfully assigned.`;

          // Display assigned tickets
          if (data.assignedTickets.length > 0) {
            let ticketsList = '<ul class="list-group">';
            data.assignedTickets.forEach((ticket) => {
              ticketsList += `
              <li class="list-group-item d-flex justify-content-between align-items-center">
                ${ticket.playerName}
                <span class="badge bg-primary rounded-pill">Ticket #${ticket.ticketNumber}</span>
              </li>
            `;
            });
            ticketsList += "</ul>";
            assignedTicketsList.innerHTML = ticketsList;
          } else {
            assignedTicketsList.innerHTML = "";
          }

          successModal.show();

          // Reload registrations after assign
          viewRegistrations(
            currentEventId,
            selectedEventName.textContent.replace("Registrations for: ", "")
          );
        } else {
          alert(data.message || "Failed to assign tickets. Please try again.");
        }

        // Reset button state
        assignTicketsBtn.disabled = false;
        assignTicketsBtn.innerHTML =
          '<i class="bi bi-ticket-perforated"></i> Assign Queue Tickets';
      })
      .catch((error) => {
        console.error("Error assigning tickets:", error);
        alert("An error occurred while assigning tickets. Please try again.");

        // Reset button state
        assignTicketsBtn.disabled = false;
        assignTicketsBtn.innerHTML =
          '<i class="bi bi-ticket-perforated"></i> Assign Queue Tickets';
      });
  }

  // Initialize on DOM content loaded
  document.addEventListener("DOMContentLoaded", function () {
    console.log("Document ready, initializing event registration management");

    // Get DOM elements
    eventsTable = document.getElementById("events-table");
    eventsListDiv = document.getElementById("events-list");
    eventRegistrationsDiv = document.getElementById("event-registrations");
    registrationsTable = document.getElementById("registrations-table");
    selectedEventName = document.getElementById("selected-event-name");
    backToEventsBtn = document.getElementById("back-to-events");
    refreshBtn = document.getElementById("refresh-btn");
    selectAllCheckbox = document.getElementById("select-all-registrations");
    assignTicketsBtn = document.getElementById("assign-tickets-btn");
    successMessage = document.getElementById("success-message");
    assignedTicketsList = document.getElementById("assigned-tickets-list");
    successModal = new bootstrap.Modal(document.getElementById("successModal"));

    // Log element references to ensure they're found
    console.log("DOM Elements:", {
      eventsTable: !!eventsTable,
      eventsListDiv: !!eventsListDiv,
      eventRegistrationsDiv: !!eventRegistrationsDiv,
      registrationsTable: !!registrationsTable,
      selectedEventName: !!selectedEventName,
      backToEventsBtn: !!backToEventsBtn,
      refreshBtn: !!refreshBtn,
      selectAllCheckbox: !!selectAllCheckbox,
      assignTicketsBtn: !!assignTicketsBtn,
    });

    // Event listeners
    backToEventsBtn.addEventListener("click", function () {
      console.log("Back to events clicked");
      eventsListDiv.classList.remove("d-none");
      eventRegistrationsDiv.classList.add("d-none");
      currentEventId = null;
    });

    refreshBtn.addEventListener("click", function () {
      console.log("Refresh clicked");
      loadEvents();
    });

    selectAllCheckbox.addEventListener("change", function () {
      document
        .querySelectorAll(".registration-checkbox")
        .forEach((checkbox) => {
          checkbox.checked = this.checked;
        });
      updateAssignButtonState();
    });

    assignTicketsBtn.addEventListener("click", assignTickets);

    // Initial load
    loadEvents();
  });
</script>
