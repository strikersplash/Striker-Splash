<div class="container mt-5">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-4">
      <!-- Team Profile Card -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-people-fill"></i> Team Profile</h5>
        </div>
        <div class="card-body text-center">
          <div class="team-avatar mb-3">
            <div
              class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center mx-auto"
              style="
                width: 120px;
                height: 120px;
                font-size: 2.5rem;
                font-weight: bold;
              "
            >
              <%= team.name.charAt(0).toUpperCase() %>
            </div>
          </div>
          <h4 class="mb-2"><%= team.name %></h4>
          <p class="text-muted mb-2">
            <i class="bi bi-calendar-event"></i>
            Created <%= new Date(team.created_at).toLocaleDateString() %>
          </p>
          <p class="text-muted mb-3">
            <i class="bi bi-people"></i>
            <span class="badge <%= (members && team.team_size && members.length >= team.team_size) ? 'bg-danger' : 'bg-success' %>">
              <%= members ? members.length : 0 %>/<%= team.team_size || '?' %>
            </span> 
            members (<%= team.team_size %>-a-side team)
          </p>

          <% if (isMember) { %>
          <div class="d-grid gap-2">
            <% if (user && team.captain_id === parseInt(user.id)) { %>
            <button class="btn btn-success" disabled>
              <i class="bi bi-star-fill"></i> Team Captain
            </button>
            <% } else { %>
            <button class="btn btn-outline-success" disabled>
              <i class="bi bi-check-circle"></i> Team Member
            </button>
            <% } %>
            <form
              action="/teams/leave"
              method="POST"
              onsubmit="return confirm('Are you sure you want to leave this team?');"
            >
              <input type="hidden" name="teamId" value="<%= team.id %>" />
              <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                <i class="bi bi-box-arrow-right"></i> Leave Team
              </button>
            </form>
          </div>
          <% } else { %>
          <button
            type="button"
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#joinModal<%= team.id %>"
          >
            <i class="bi bi-person-plus me-1"></i>Request to Join
          </button>

          <!-- Join Request Modal -->
          <div class="modal fade" id="joinModal<%= team.id %>" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Request to Join <%= team.name %></h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                  ></button>
                </div>
                <form action="/teams/join/<%= team.id %>" method="POST">
                  <div class="modal-body text-start">
                    <div class="mb-3">
                      <label for="message<%= team.id %>" class="form-label"
                        >Message (Optional)</label
                      >
                      <textarea
                        class="form-control"
                        id="message<%= team.id %>"
                        name="message"
                        rows="3"
                        placeholder="Tell the team captain why you'd like to join..."
                      ></textarea>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn btn-secondary"
                      data-bs-dismiss="modal"
                    >
                      Cancel
                    </button>
                    <button type="submit" class="btn btn-success">
                      <i class="bi bi-send me-1"></i>Send Request
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <% } %>
        </div>
      </div>

      <!-- Quick Actions Card -->
      <div class="card mb-4">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-lightning-fill"></i> Quick Actions
          </h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <a href="/teams/browse" class="btn btn-outline-secondary">
              <i class="bi bi-search"></i> Browse All Teams
            </a>
            <% if (user && team.captain_id === parseInt(user.id)) { %>
            <a
              href="/teams/manage/<%= team.id %>"
              class="btn btn-outline-warning"
            >
              <i class="bi bi-gear"></i> Manage Team
            </a>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Team Info Card -->
      <div class="card">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0"><i class="bi bi-info-circle"></i> Team Info</h5>
        </div>
        <div class="card-body text-center">
          <h6 class="text-muted">Total Goals</h6>
          <h2 class="text-warning"><%= stats.total_goals || 0 %></h2>
          <small class="text-muted">Team performance</small>
        </div>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-8">
      <!-- Team Stats Card -->
      <div class="card mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-bar-chart-fill"></i> Team Performance
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4 mb-3">
              <div class="card text-center bg-light border-success">
                <div class="card-body">
                  <div class="text-success mb-2">
                    <i class="bi bi-bullseye" style="font-size: 2.5rem"></i>
                  </div>
                  <h5 class="card-title text-success">Total Goals</h5>
                  <h2 class="text-success"><%= stats.total_goals || 0 %></h2>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card text-center bg-light border-primary">
                <div class="card-body">
                  <div class="text-primary mb-2">
                    <i class="bi bi-arrow-repeat" style="font-size: 2.5rem"></i>
                  </div>
                  <h5 class="card-title text-primary">Total Attempts</h5>
                  <h2 class="text-primary"><%= stats.total_attempts || 0 %></h2>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <div class="card text-center bg-light border-warning">
                <div class="card-body">
                  <div class="text-warning mb-2">
                    <i class="bi bi-percent" style="font-size: 2.5rem"></i>
                  </div>
                  <h5 class="card-title text-warning">Accuracy</h5>
                  <h2 class="text-warning">
                    <%= stats.total_attempts ? ((stats.total_goals /
                    stats.total_attempts) * 100).toFixed(1) : 0 %>%
                  </h2>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <% if (isCaptain) { %>
      <!-- Captain Management Section -->
      <div class="card mb-4 border-warning">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">
            <i class="bi bi-shield-fill"></i> Team Management
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <!-- Edit Team Name -->
              <h6 class="text-warning">
                <i class="bi bi-pencil"></i> Edit Team Name
              </h6>
              <form action="/teams/update-name" method="POST" class="mb-3">
                <input type="hidden" name="teamId" value="<%= team.id %>" />
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control"
                    name="newName"
                    value="<%= team.name %>"
                    required
                  />
                  <button class="btn btn-outline-warning" type="submit">
                    Update
                  </button>
                </div>
              </form>
            </div>
            <div class="col-md-6">
              <!-- Transfer Captaincy -->
              <h6 class="text-warning">
                <i class="bi bi-arrow-repeat"></i> Transfer Captaincy
              </h6>
              <form
                action="/teams/transfer-captaincy"
                method="POST"
                class="mb-3"
              >
                <input type="hidden" name="teamId" value="<%= team.id %>" />
                <div class="input-group">
                  <select class="form-select" name="newCaptainId" required>
                    <option value="">Select new captain...</option>
                    <% members.forEach(member => { %> <% if (!member.is_captain)
                    { %>
                    <option value="<%= member.player_id %>">
                      <%= member.name %>
                    </option>
                    <% } %> <% }); %>
                  </select>
                  <button class="btn btn-outline-warning" type="submit">
                    Transfer
                  </button>
                </div>
              </form>
            </div>
          </div>
          
          <hr />
          
          <div class="row mt-3">
            <div class="col-md-6">
              <!-- Edit Team Size -->
              <h6 class="text-warning">
                <i class="bi bi-people"></i> Update Team Size
              </h6>
              <form action="/teams/update-size" method="POST" class="mb-3">
                <input type="hidden" name="teamId" value="<%= team.id %>" />
                <div class="input-group">
                  <select class="form-select" name="newSize" required>
                    <option value="">Select team size...</option>
                    <option value="3" <%= team.team_size === 3 ? 'selected' : '' %>>3-a-side</option>
                    <option value="5" <%= team.team_size === 5 ? 'selected' : '' %>>5-a-side</option>
                    <option value="10" <%= team.team_size === 10 ? 'selected' : '' %>>10-a-side</option>
                    <option value="11" <%= team.team_size === 11 ? 'selected' : '' %>>11-a-side</option>
                    <option value="18" <%= team.team_size === 18 ? 'selected' : '' %>>18-a-side (Full Squad)</option>
                    <option value="23" <%= team.team_size === 23 ? 'selected' : '' %>>23-a-side (Extended Squad)</option>
                  </select>
                  <button class="btn btn-outline-warning" type="submit">
                    Update
                  </button>
                </div>
                <small class="text-muted">Current: <%= team.team_size %>-a-side</small>
              </form>
            </div>
            
            <div class="col-md-6">
              <!-- Delete Team -->
              <h6 class="text-danger">
                <i class="bi bi-exclamation-triangle"></i> Danger Zone
              </h6>
              <form 
                action="/teams/delete" 
                method="POST" 
                class="mb-3"
                onsubmit="return confirm('Are you sure you want to delete this team? This action cannot be undone!');">
                <input type="hidden" name="teamId" value="<%= team.id %>" />
                <div class="d-grid">
                  <button class="btn btn-danger" type="submit">
                    <i class="bi bi-trash"></i> Delete Team
                  </button>
                </div>
                <small class="text-muted">This action is permanent and cannot be undone.</small>
              </form>
            </div>
          </div>

          <!-- Join Requests -->
          <% if (joinRequests && joinRequests.length > 0) { %>
          <hr />
          <h6 class="text-warning">
            <i class="bi bi-person-plus"></i> Join Requests (<%=
            joinRequests.length %>)
          </h6>
          <div class="row">
            <% joinRequests.forEach(request => { %>
            <div class="col-md-6 mb-3">
              <div class="card border-info">
                <div class="card-body">
                  <div class="d-flex align-items-center mb-2">
                    <div
                      class="bg-info text-white rounded-circle d-flex align-items-center justify-content-center me-3"
                      style="width: 40px; height: 40px"
                    >
                      <i class="bi bi-person"></i>
                    </div>
                    <div>
                      <h6 class="mb-0"><%= request.name %></h6>
                      <small class="text-muted"
                        ><%= request.residence %> • <%= request.age_group
                        %></small
                      >
                    </div>
                  </div>
                  <% if (request.message) { %>
                  <p class="card-text small text-muted">
                    "<%= request.message %>"
                  </p>
                  <% } %>
                  <div class="text-center">
                    <small class="text-muted"
                      >Goals: <%= request.total_goals || 0 %> • Games: <%=
                      request.total_games || 0 %></small
                    >
                  </div>
                  <div class="d-flex gap-2 mt-2">
                    <form
                      action="/teams/join-request/<%= request.id %>/approve"
                      method="POST"
                      class="flex-fill"
                    >
                      <button class="btn btn-success btn-sm w-100">
                        <i class="bi bi-check"></i> Approve
                      </button>
                    </form>
                    <form
                      action="/teams/join-request/<%= request.id %>/reject"
                      method="POST"
                      class="flex-fill"
                    >
                      <button class="btn btn-danger btn-sm w-100">
                        <i class="bi bi-x"></i> Reject
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            <% }); %>
          </div>
          <% } %>
        </div>
      </div>
      <% } %>

      <!-- Team Members Card -->
      <div class="card mb-4">
        <div
          class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0"><i class="bi bi-people"></i> Team Members</h5>
          <span class="badge bg-light text-dark">
            <span class="<%= (members && team.team_size && members.length >= team.team_size) ? 'text-danger' : 'text-success' %>">
              <%= members ? members.length : 0 %>/<%= team.team_size || '?' %>
            </span> 
            members
          </span
          >
        </div>
        <div class="card-body">
          <% if (members && members.length > 0) { %>
          <div class="row">
            <% members.forEach(member => { %>
            <div class="col-md-6 mb-3">
              <div class="card border-0 bg-light">
                <div class="card-body p-3">
                  <div class="d-flex align-items-center">
                    <div id="member-avatar-<%= member.id %>" class="me-3"></div>
                    <script>
                      document.addEventListener(
                        "DOMContentLoaded",
                        function () {
                          const avatarContainer = document.getElementById(
                            "member-avatar-<%= member.id %>"
                          );
                          const avatar = createAvatar(
                            "<%= member.name %>",
                            50,
                            '<%= member.photo_path || "" %>'
                          );
                          avatar.classList.add(
                            "border",
                            "border-2",
                            "border-white"
                          );
                          avatarContainer.appendChild(avatar);
                        }
                      );
                    </script>
                    <div class="flex-grow-1">
                      <h6 class="mb-1">
                        <%= member.name %> <% if (member.is_captain) { %>
                        <span class="badge bg-warning ms-1">
                          <i class="bi bi-star-fill"></i> Captain
                        </span>
                        <% } %>
                      </h6>
                      <small class="text-muted">
                        <i class="bi bi-geo-alt"></i> <%= member.residence %> <%
                        if (member.city_village) { %>, <%= member.city_village
                        %><% } %>
                      </small>
                      <br />
                      <small class="text-muted">
                        <i class="bi bi-calendar3"></i> <%= member.age_group %>
                      </small>
                    </div>
                    <div class="text-end">
                      <div class="badge bg-success">
                        <i class="bi bi-bullseye"></i> <%= member.goals || 0 %>
                      </div>
                      <br />
                      <small class="text-muted">goals</small>
                      <% if (isCaptain && !member.is_captain) { %>
                      <br />
                      <form
                        action="/teams/remove-member"
                        method="POST"
                        class="mt-2"
                        onsubmit="return confirm('Are you sure you want to remove this member?')"
                      >
                        <input
                          type="hidden"
                          name="teamId"
                          value="<%= team.id %>"
                        />
                        <input
                          type="hidden"
                          name="memberId"
                          value="<%= member.player_id %>"
                        />
                        <button
                          type="submit"
                          class="btn btn-outline-danger btn-sm"
                        >
                          <i class="bi bi-trash"></i>
                        </button>
                      </form>
                      <% } %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <% }); %>
          </div>
          <% } else { %>
          <div class="text-center py-4">
            <i class="bi bi-people text-muted" style="font-size: 3rem"></i>
            <h6 class="text-muted mt-2">No members found</h6>
            <p class="text-muted">Invite players to join your team!</p>
          </div>
          <% } %>
        </div>
      </div>

      <!-- Session History Card -->
      <div class="card mb-5">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="bi bi-clock-history"></i> Recent Sessions
          </h5>
        </div>
        <div class="card-body">
          <% if (typeof sessionStats !== 'undefined' && sessionStats &&
          sessionStats.length > 0) { %>
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th><i class="bi bi-calendar3"></i> Date</th>
                  <th><i class="bi bi-bullseye"></i> Goals</th>
                  <th><i class="bi bi-target"></i> Attempts</th>
                  <th><i class="bi bi-percent"></i> Accuracy</th>
                  <th>Performance</th>
                </tr>
              </thead>
              <tbody>
                <% sessionStats.forEach(session => { %>
                <tr>
                  <td>
                    <strong
                      ><%= new Date(session.session_date).toLocaleDateString()
                      %></strong
                    >
                    <br />
                    <small class="text-muted"
                      ><%= new
                      Date(session.session_date).toLocaleDateString('en-US', {
                      weekday: 'long' }) %></small
                    >
                  </td>
                  <td>
                    <span class="badge bg-success fs-6"
                      ><%= session.total_goals %></span
                    >
                  </td>
                  <td>
                    <span class="badge bg-primary fs-6"
                      ><%= session.total_attempts %></span
                    >
                  </td>
                  <td>
                    <span class="badge bg-warning fs-6"
                      ><%= (session.accuracy * 100).toFixed(1) %>%</span
                    >
                  </td>
                  <td>
                    <span class="badge bg-info">
                      <%= (session.accuracy * 100).toFixed(1) %>%
                    </span>
                  </td>
                </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
          <% } else { %>
          <div class="text-center py-4">
            <i class="bi bi-graph-up text-muted" style="font-size: 3rem"></i>
            <h6 class="text-muted mt-2">No sessions recorded yet</h6>
            <p class="text-muted">Start playing to see your team's progress!</p>
          </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Make icons in team dashboard smaller */
  .card .bi:not(.team-avatar .bi) {
    font-size: 1rem !important;
  }
  
  /* Specific size for member goal icons */
  .badge .bi-bullseye {
    font-size: 0.9rem !important;
  }
  
  /* Make team performance icons bigger - be more specific */
  .card.bg-light.border-success .bi-bullseye,
  .card.bg-light.border-primary .bi-arrow-repeat,
  .card.bg-light.border-warning .bi-percent {
    font-size: 2.5rem !important;
  }

  /* Tablet-specific responsive fixes */
  @media (min-width: 768px) and (max-width: 991.98px) {
    /* Make sidebar take full width on tablet */
    .col-md-4 {
      flex: 0 0 100%;
      max-width: 100%;
      margin-bottom: 1.5rem;
    }
    
    /* Make main content take full width on tablet */
    .col-md-8 {
      flex: 0 0 100%;
      max-width: 100%;
    }
    
    /* Adjust team performance cards for tablet - keep them in 3 columns */
    .col-md-4.mb-3 {
      flex: 0 0 33.333333%;
      max-width: 33.333333%;
    }
    
    /* Adjust team member cards for tablet - keep 2 columns */
    .col-md-6.mb-3 {
      flex: 0 0 50%;
      max-width: 50%;
    }
    
    /* Ensure proper spacing between sections */
    .card.mb-4 {
      margin-bottom: 1.5rem !important;
    }
    
    /* Add spacing before Recent Sessions card */
    .card.mb-5 {
      margin-bottom: 3rem !important;
      margin-top: 1rem;
    }
    
    /* Adjust team avatar size for tablet */
    .team-avatar div {
      width: 100px !important;
      height: 100px !important;
      font-size: 2rem !important;
    }
    
    /* Optimize card padding for tablet */
    .card-body {
      padding: 1rem;
    }
    
    /* Better spacing for management forms on tablet */
    .col-md-6 {
      margin-bottom: 1rem;
    }
  }
</style>
